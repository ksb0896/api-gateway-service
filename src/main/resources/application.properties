# API Gateway Routing Configuration

# Server Port: The gateway runs publicly on port 8080. (Entry point)
server.port=8080

# Application name
spring.application.name=api_gateway
spring.main.web-application-type=reactive

# --- Route 0: Profile Photo Service---
spring.cloud.gateway.routes[0].id=profile_photo_route
spring.cloud.gateway.routes[0].uri=http://localhost:8082
spring.cloud.gateway.routes[0].predicates[0]=Path=/v1/banks/*/users/*/photo/**
spring.cloud.gateway.routes[0].filters[0]=Authentication
spring.cloud.gateway.routes[0].filters[1]=CircuitBreaker=profilePhotoBreaker,forward:/fallback/profile-photo
spring.cloud.gateway.routes[0].filters[2]=RewritePath=/v1/(?<segment>.*), /v1/$\\{segment}


# --- Route 1: User Profile Service---
spring.cloud.gateway.routes[1].id=user-profile-service
spring.cloud.gateway.routes[1].uri=http://localhost:8081
spring.cloud.gateway.routes[1].predicates[0]=Path=/v1/banks/*/users,/v1/banks/*/users/**
spring.cloud.gateway.routes[1].filters[0]=Authentication
spring.cloud.gateway.routes[1].filters[1]=StripPrefix=0


# --- Route 2: Auth Service---
spring.cloud.gateway.routes[2].id=auth_route
spring.cloud.gateway.routes[2].uri=http://localhost:8083
spring.cloud.gateway.routes[2].predicates[0]=Path=/auth/**
spring.cloud.gateway.routes[2].filters[0]=StripPrefix=0

# --- Grafana Configuration ---
# Actuator & Prometheus
management.endpoints.web.exposure.include=prometheus,health,info,metrics
management.endpoint.prometheus.enabled=true
management.metrics.export.prometheus.enabled=true
management.metrics.distribution.percentiles-histogram.http.server.requests=true

# OpenTelemetry
otel.traces.exporter=otlp
otel.exporter.otlp.endpoint=http://tempo:4317
otel.sdk.trace.sampler=always_on
otel.service.name=api-gateway

# Loki Logging
logging.config=classpath:logback-spring.xml

#Resilinece4j Properties
resilience4j.circuitbreaker.configs.default.registerHealthIndicator=true
resilience4j.circuitbreaker.configs.default.slidingWindowType=COUNT_BASED
resilience4j.circuitbreaker.instances.photoServiceCircuitBreaker.failureRateThreshold=50
resilience4j.circuitbreaker.instances.userProfileBreaker.failureRateThreshold=50
resilience4j.circuitbreaker.configs.default.slidingWindowSize=10
resilience4j.circuitbreaker.configs.default.failureRateThreshold=50
resilience4j.circuitbreaker.configs.default.waitDurationInOpenState=5s
resilience4j.circuitbreaker.configs.default.permittedNumberOfCallsInHalfOpenState=3
resilience4j.circuitbreaker.configs.default.automaticTransitionFromOpenToHalfOpenEnabled=true
resilience4j.circuitbreaker.configs.default.minimum-number-of-calls=5

#Resilience4J Retry Properties
resilience4j.retry.configs.default.max-attempts=3
resilience4j.retry.configs.default.wait-duration=2s

#Resilience4J Timeout Properties
resilience4j.timelimiter.configs.default.timeout-duration=3s
resilience4j.timelimiter.instances.photoServiceTimeLimiter.timeoutDuration=800ms
resilience4j.timelimiter.instances.userProfileBreaker.timeoutDuration=800ms

#LOGGING
logging.level.org.springframework.cloud.gateway=DEBUG
logging.level.reactor.netty.http.client=DEBUG
logging.level.com.ksb.micro.api_gateway.filter=DEBUG
logging.level.com.ksb.micro.api_gateway.util=DEBUG

# ========== SWAGGER/OPENAPI DOCUMENTATION CONFIGURATION ==========

# ---- Swagger Routes for Microservices Documentation ----
# Route 3: User Profile Service Swagger Docs
spring.cloud.gateway.routes[3].id=user-profile-docs
spring.cloud.gateway.routes[3].uri=http://localhost:8081
spring.cloud.gateway.routes[3].predicates[0]=Path=/v3/api-docs/user-profile,/v3/api-docs/user-profile/**
spring.cloud.gateway.routes[3].filters[0]=RewritePath=/v3/api-docs/user-profile, /v3/api-docs

# Route 4: Profile Photo Service Swagger Docs
spring.cloud.gateway.routes[4].id=profile-photo-docs
spring.cloud.gateway.routes[4].uri=http://localhost:8082
spring.cloud.gateway.routes[4].predicates[0]=Path=/v3/api-docs/profile-photo,/v3/api-docs/profile-photo/**
spring.cloud.gateway.routes[4].filters[0]=RewritePath=/v3/api-docs/profile-photo, /v3/api-docs

# Route 5: Auth Service Swagger Docs
spring.cloud.gateway.routes[5].id=auth-service-docs
spring.cloud.gateway.routes[5].uri=http://localhost:8083
spring.cloud.gateway.routes[5].predicates[0]=Path=/v3/api-docs/auth-service,/v3/api-docs/auth-service/**
spring.cloud.gateway.routes[5].filters[0]=RewritePath=/v3/api-docs/auth-service, /v3/api-docs

# ---- SpringDoc OpenAPI Configuration ----
# API Docs path for the gateway
springdoc.api-docs.path=/v3/api-docs

# Swagger UI Configuration
springdoc.swagger-ui.path=/swagger-ui.html
springdoc.swagger-ui.enabled=true
springdoc.swagger-ui.operations-sorter=method
springdoc.swagger-ui.tags-sorter=alpha

# ---- Swagger UI URLs - Multiple Service Documentation ----
# Configure the dropdown to show all microservices
springdoc.swagger-ui.urls[0].url=/v3/api-docs
springdoc.swagger-ui.urls[0].name=API Gateway (8080)
springdoc.swagger-ui.urls[0].primaryName=true

springdoc.swagger-ui.urls[1].url=/v3/api-docs/user-profile
springdoc.swagger-ui.urls[1].name=User Profile Service (8081)

springdoc.swagger-ui.urls[2].url=/v3/api-docs/profile-photo
springdoc.swagger-ui.urls[2].name=Profile Photo Service (8082)

springdoc.swagger-ui.urls[3].url=/v3/api-docs/auth-service
springdoc.swagger-ui.urls[3].name=Auth Service (8083)

# Show the group selector
springdoc.swagger-ui.show-extensions=true
springdoc.swagger-ui.doc-expansion=list

#default login
spring.security.user.name=disabled
spring.security.user.password=disabled

spring.autoconfigure.exclude=org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration